<!doctype html>

<html lang='en'>
  <head>
    <meta charset='utf-8'/>
    <title>yt++</title>
    <script src='modules/streamer.js'></script>
    <script>
      // get remote and ipcRenderer (interprocess communication), dialog (for saving)
      const {remote, ipcRenderer} = require('electron');
      // get internal api
      const api = remote.require('./api.js');

      // setup jquery
      window.$ = window.jQuery = require('jquery');

      // apply event handlers on document ready
      $(document).ready(() => {
        // configure download handler
        $('#download').mousedown(() => {
          try {
            // try and fail if anything goes wrong
            // val1 = query, val2 = filepath, val3 = format
            api.download($('#query').val(), $('#file-path').val(), $('#format').val());
          }
          catch (e) {
            // echo to status
            $('#status').html('Error: ' + e);
          }
        });

        // configure audio stream handler
        $('#stream').mousedown(() => {
          // get device id to stream to
          getDevices().then(devices => {
            let deviceId = devices[$('#device').val()];
            try {
              // play stream
              // query, volume (as string), device id
              api.getStreamUrl($('#query').val()).then(sUrl => {
                  playStream(sUrl, $('#volume').val(), deviceId);
              },
              err => {
                setStatus('Error: ' + err, 0);
              })

            }
            catch (e) {
              // echo to status
              $('#status').html('Error: ' + e, 0);
            }
          },
          err => {
            $('#status').html('Error: ' + err, 0);
          });

        });

        // configure pause button
        $('#set-pause').mousedown(() => {
          // set pause internal api call
          // no known points of fatal failure so no need for try catch
          setStreamPause();

          // update text
          $('#set-pause').html($('#set-pause').html() == 'Pause' ? 'Resume' : 'Pause');

          // update status
          setStatus($('#set-pause').html() + 'd Audio.');
        });

        $('#stop-stream').mousedown(() => {
          // stop audio
          stopStream();

          // update status
          setStatus('Stopped Audio.', 0);
        });

        // allow searching
        $('#search').mousedown(() => {
          // get info and eval promise
          api.getInfo($('#query').val()).then(data => {
            let htmlifiedResponse = `<img height=\'54px\' width=\'96px\'src=\'${data.thumbnail}\'/>
            \n<span class=\'title\'>${data.title}</span>
            \n<br /><span class=\'video-url\'>${data.url}</span>`;

            // add into search results
            $('#search-results').html(htmlifiedResponse);
          },
          err => {
            // update status if failed to get info
            setStatus('Error: ' + err, 0);
          });
        });

        // select download location
        $('#select-file').mousedown(() => {
          // open dialog
          let filename = remote.dialog.showSaveDialog();
          // set result into the file-name field
          $('#file-path').val(filename);
        });
      });

      // set progress bar and status message
      function setStatus(message, progress) {
        // set status variable
        $('#status').html(message);
        // TODO update progress bar
      }

      // allow main process to set the remote status
      ipcRenderer.on('set-status', (event, args) => {
        setStatus(args.message, args.progress);
      });
    </script>
  </head>
  <body>
    <div id='searchbar'>
      <input id='query' type='text'/>
      <button id='search'>Search</button>
      <div id='search-results'>

      </div>
    </div>
    <div class='formbox'>
      <button id='download'>Download As</button>
      <select id='format'>
        <optgroup label='Video'>
          <option>mp4</option>
          <option>flv</option>
          <option>avi</option>
          <option>3gp</option>
          <option>webm</option>
          <option>mov</option>
        </optgroup>
        <optgroup label='Audio'>
          <option>mp3</option>
          <option>m4a</option>
          <option>wav</option>
          <option>ogg</option>
        </optgroup>
      </select>
      <input id='file-path' type='text'/>
      <button id='select-file'>Select</button>
    </div>
    <div class='formbox'>
      <button id='stream'>Stream Audio</button>
      <button id='set-pause'>Pause</button>
      <button id='stop-stream'>Stop</button>
      <label for='#volume'>Volume</label>
      <input id='volume' type='range' min='0' max='100' value='50' onchange="updateVolume(Number($('#volume').val()));"/>
      <label for='#device'>Device</label>
      <select id='device'>
        <!-- populate at run time-->
        <script>
          getDevices().then((devices) => {
            let deviceList = Object.keys(devices);
            let optionsHtml = '';
            for(var x of deviceList) {
              optionsHtml += `<option>${x}</option>`;
            }
            $('#device').html(optionsHtml);
          },
          err => {
            throw err;
          })
        </script>
      </select>
    </div>
    <div id='status-box'>
      <span id='status'></span>
    </div>
    <ul class='queue'>
    </ul>
  </body>
</html>
